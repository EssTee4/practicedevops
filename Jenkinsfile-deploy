pipeline {
    agent any

    environment {
        IMAGE_NAME = "test"
        DOCKER_USER = "esstee911"
    }

    stages {
        stage('Pull Latest Image') {
            steps {
                script {
                    sh "docker pull ${DOCKER_USER}/${IMAGE_NAME}:latest"
                }
            }
        }

        stage('Pull stable Image') {
            steps {
                script {
                    sh "docker pull ${DOCKER_USER}/${IMAGE_NAME}:stable || echo 'stable version not found'"
                }
            }
        }
    
        stage('Stop Previous Container') {
            steps {
                script {
                    echo "Stopping existing container if running..."
                    sh "docker stop ${IMAGE_NAME} || true"
                    sh "docker rm ${IMAGE_NAME} || true"
                }
            }
        }

        stage('Run New Container') {
            steps {
                script {
                    echo "Running new container on port 4444"
                    sh "docker run -d -p 4444:80 --name ${IMAGE_NAME} ${DOCKER_USER}/${IMAGE_NAME}:latest"
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    def status = sh(script: "docker ps | grep ${IMAGE_NAME} | wc -l", returnStdout: true).trim()
                    if (status != "1") {
                        error("Deployment failed!")
                    } 
                else {
                        echo "Deployment successful."
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Tagging deployed image as stable..."
            withCredentials([usernamePassword(credentialsId: "dockerhub", usernameVariable: "dockerUser", passwordVariable: "dockerPass")]) {
                    sh '''
                        echo $dockerPass | docker login -u $dockerUser --password-stdin
                        docker tag ${DOCKER_USER}/${IMAGE_NAME}:stable ${DOCKER_USER}/${IMAGE_NAME}:build-${BUILD_NUMBER} || true
                        docker push ${DOCKER_USER}/${IMAGE_NAME}:${BUILD_NUMBER} || true
                        docker tag ${DOCKER_USER}/${IMAGE_NAME}:latest ${DOCKER_USER}/${IMAGE_NAME}:stable
                        docker push ${DOCKER_USER}/${IMAGE_NAME}:stable
                        docker logout
                    '''
            }
        }
        failure {
            echo "Deployment failed, rolling back..."
            sh '''
                docker stop ${IMAGE_NAME}
                docker rm ${IMAGE_NAME}
                docker run -d -p 4444:80 --name ${IMAGE_NAME} ${DOCKER_USER}/${IMAGE_NAME}:stable || echo "No backup image to roll back!"
            '''
        }
    }
}
